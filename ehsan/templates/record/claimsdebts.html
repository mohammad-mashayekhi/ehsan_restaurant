{% extends 'main/main.html' %}
{% load static %}
{% block contant %}
<style>
    .small-td {
        width: 15%;
    }

    .th {
        background-color: #6CC3DA !important;
        color: white !important;
        font-weight: bold !important;
        font-size: 1vw !important;
    }

    .customtable {
        font-weight: bold !important;
        font-size: large;
    }

    .price-input {
        padding: 3px !important;
        background-color: #E4F4F8;
        border-color: #E4F4F8;
        font-size: larger;
    }

    .table-responsive {
        height: 600px;
        overflow-y: auto;
        direction: ltr;
    }

    .search-container {
        display: inline-block;
    }

    .table-responsive table {
        direction: rtl;
    }

    .form-control-sm {
        border-color: white !important;
    }

    .btn-arrow {
        background-color: #FF8A00;
        color: white;
        width: 1%;
        height: 1%;
        padding: 1%;
    }

    .form-group {
        margin-bottom: 20px;
    }
    .btn-arrow{
        background-color: #FF8A00;
        color: white;
        width: 0.2vw;
    }
    .card_head_title {
        font-size: 1vw;
        color: #c1e4ea;
        padding: 5px;
        background: #2CA9C9 !important;
        border-radius: 15px;
    }
</style>
<div class="container-xxl flex-grow-1 container-p-y">
    <h4 class="fw-bold pt-3 mb-4">
        <span class="text-muted fw-light">مطالبات و بدهی‌ها/</span> افزودن مطالبات و بدهی‌ها
    </h4>
    <div class="card mb-4" style="background-color: #c1e4ea; box-shadow: none;">
        <div class="card-header" style="margin-inline: 60px;">
            <button class="btn-arrow btn" id="prevDayBtn"><<</button>
            <input class='form-control-sm date' style="text-align: center;"  type="text" id="date" value="{{jalali_date}}" placeholder="{{date}}"/>
            <button class="btn-arrow btn" id="nextDayBtn">>></button>
        </div>
        <div class="card-body">
            <div class="card mb-4" style="margin-inline: 60px; box-shadow: none;">
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <div class="row card_head_title p-1 mb-2" style="align-items: center;">
                            <div class="col-md-7 text-center">
                                <span style="font-weight: bold;">افزودن طلب</span>
                                {{ claims_form.type }}
                            </div>
                            <div class="col-md-2 text-center">
                                <span>آیدی طلب:</span>
                            </div>
                            <div class="col-md-3 " style="margin-right: -30px;">
                                {{ claims_form.claimsdebts_id }}
                            </div>
                        </div>
                        <div id="claims-ingredient-forms">
                            {{ claims_formset.management_form }}
                            <div class="row">
                                {% for form in claims_formset %}
                                <div class="col-md-3 ingredient-form form-group">
                                    {{ form.name.label_tag }}
                                    {{ form.name }}
                                    {{ form.amount.label_tag }}
                                    {{ form.amount }}
                                </div>
                                {% if forloop.counter|divisibleby:4 and not forloop.last %}
                            </div>
                            <div class="row">
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        <button type="button" id="add-claims-ingredient" class="btn btn-secondary">افزودن طلب
                            جدید</button>
                        <hr>

                        <div class="row card_head_title p-1 mb-2" style="align-items: center;">
                            <div class="col-md-7 text-center">
                                <span style="font-weight: bold;">افزودن بدهی</span>
                                {{ debts_form.type }}
                            </div>
                            <div class="col-md-2 text-center">
                                <span>آیدی بدهی:</span>
                            </div>
                            <div class="col-md-3 " style="margin-right: -30px;">
                                {{ debts_form.claimsdebts_id }}
                            </div>
                        </div>
                        <div id="debts-ingredient-forms">
                            {{ debts_formset.management_form }}
                            <div class="row">
                                {% for form in debts_formset %}
                                <div class="col-md-3 ingredient-form form-group">
                                    {{ form.name.label_tag }}
                                    {{ form.name }}
                                    {{ form.amount.label_tag }}
                                    {{ form.amount }}
                                </div>
                                {% if forloop.counter|divisibleby:4 and not forloop.last %}
                            </div>
                            <div class="row">
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        <button type="button" id="add-debts-ingredient" class="btn btn-secondary">افزودن بدهی
                            جدید</button>

                        <div class="card-footer text-muted">
                            {{ form.errors }}
                            <a href="#" onclick="window.history.go(-1); return false;"
                                class="btn btn-outline-secondary">انصراف</a>
                            <button type="submit" class="btn btn-primary">ذخیره</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block pagejs %}

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<link rel="stylesheet" href="{% static 'css/persianDatepicker-default.css' %}" />
<script src="{% static 'js/persianDatepicker.min.js' %}"></script>

<script>
    $(document).ready(function () {
    
    let claims_form_idx = {{ claims_formset.total_form_count }};
    let debts_form_idx = {{ debts_formset.total_form_count }};

    $('#add-claims-ingredient').click(function () {
        let new_form = $('#claims-ingredient-forms .ingredient-form:first').clone();

        new_form.find('input, select').each(function () {
            let name = $(this).attr('name').replace(/\d+/, claims_form_idx);
            let id = $(this).attr('id').replace(/\d+/, claims_form_idx);
            $(this).attr({ 'name': name, 'id': id }).val('');
        });

        let current_row = $('#claims-ingredient-forms .row').last();
        if (current_row.children().length >= 4) {
            current_row = $('<div class="row"></div>').appendTo('#claims-ingredient-forms');
        }

        new_form.appendTo(current_row);

        claims_form_idx++;
        updateManagementForm(claims_form_idx, 'claims_ingredients');
    });

    $('#add-debts-ingredient').click(function () {
        let new_form = $('#debts-ingredient-forms .ingredient-form:first').clone();

        new_form.find('input, select').each(function () {
            let name = $(this).attr('name').replace(/\d+/, debts_form_idx);
            let id = $(this).attr('id').replace(/\d+/, debts_form_idx);
            $(this).attr({ 'name': name, 'id': id }).val('');
        });

        let current_row = $('#debts-ingredient-forms .row').last();
        if (current_row.children().length >= 4) {
            current_row = $('<div class="row"></div>').appendTo('#debts-ingredient-forms');
        }

        new_form.appendTo(current_row);

        debts_form_idx++;
        updateManagementForm(debts_form_idx, 'debts_ingredients');
    });

    function updateManagementForm(count, prefix) {
        $('#id_' + prefix + '-TOTAL_FORMS').val(count);
    }
    });
</script>
<script>
    var dateInput = document.getElementById('date');
    var prevDayBtn = document.getElementById('prevDayBtn');
    var nextDayBtn = document.getElementById('nextDayBtn');

    document.addEventListener('DOMContentLoaded', function () {
    
        if (!dateInput.value) {
            dateInput.value = '{{date}}';
        }

        prevDayBtn.addEventListener('click', function () {
            var placeholderValue = dateInput.getAttribute('placeholder'); // خواندن مقدار placeholder
            var dateObject = new Date(placeholderValue); // تبدیل به Date object
            dateObject.setMonth(dateObject.getMonth() - 1); // یک ماه به عقب
            dateObject.setDate(1); // تنظیم روز به 1
            var year = dateObject.getFullYear();
            var month = dateObject.getMonth() + 1; // ماه‌ها از 0 تا 11 شمرده می‌شوند، بنابراین باید یک واحد به آن اضافه کنیم
            var formattedDate = year + '-' + (month < 10 ? '0' + month : month) + '-' + '01';
    
            var url = "/record/claimsdebts/" + formattedDate + "/";
            window.location.href = url;
        });

        nextDayBtn.addEventListener('click', function () {
            var placeholderValue = dateInput.getAttribute('placeholder'); // خواندن مقدار placeholder
            var dateObject = new Date(placeholderValue); // تبدیل به Date object
            dateObject.setMonth(dateObject.getMonth() + 1); // یک ماه به جلو
            dateObject.setDate(1); // تنظیم روز به 1
            var year = dateObject.getFullYear();
            var month = dateObject.getMonth() + 1; // ماه‌ها از 0 تا 11 شمرده می‌شوند، بنابراین باید یک واحد به آن اضافه کنیم
            var formattedDate = year + '-' + (month < 10 ? '0' + month : month) + '-' + '01';
    
            var url = "/record/claimsdebts/" + formattedDate + "/";
            console.log(url)
            // window.location.href = url;
        });

        dateInput.addEventListener('change', goToSelectedDate);
    });
    $("#date").persianDatepicker({
            showGregorianDate: true,
            formatDate: "YYYY-MM-DD",
            onSelect: function () { 
                var selectedDate = document.getElementById('date').value;
                console.log(selectedDate)
                var url = "/record/claimsdebts/" + selectedDate + "/";
                window.location.href = url;            
            }, 
        });
</script>
{% endblock %}